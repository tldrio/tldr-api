<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="environments.html">                 environments.js               </a>                                           <a class="source" href="models.html">                 models.js               </a>                                           <a class="source" href="tldrModel.html">                 tldrModel.js               </a>                                           <a class="source" href="requestHandlers.html">                 requestHandlers.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                                           <a class="source" href="crypto.test.html">                 crypto.test.js               </a>                                           <a class="source" href="database.test.html">                 database.test.js               </a>                                           <a class="source" href="models.test.html">                 models.test.js               </a>                                           <a class="source" href="models_tldrModel.test.html">                 models_tldrModel.test.js               </a>                                           <a class="source" href="server.test.html">                 server.test.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Server for tldr</span>
<span class="cm"> * Copyright (C) 2012 L. Chatriot, S. Marion, C. Miglietti</span>
<span class="cm"> * Fucking Proprietary License</span>
<span class="cm"> */</span>


<span class="kd">var</span> <span class="nx">restify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;restify&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">bunyan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/logger&#39;</span><span class="p">).</span><span class="nx">bunyan</span> <span class="c1">// Audit logger for restify</span>
  <span class="p">,</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./models&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/db&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">requestHandlers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./requestHandlers&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">currentEnvironment</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./environments&#39;</span><span class="p">).</span><span class="nx">currentEnvironment</span>
  <span class="p">,</span> <span class="nx">server</span><span class="p">;</span>                                 <span class="c1">// Will store our restify server</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Last wall of defense. If an exception makes its way to the top, the service shouldn't
stop, but log a fatal error and send an email to us.
Of course, this piece of code should NEVER have to be called.
Only useful in production environment when we don't want to stop the service. Not set in development environment to get meaningful errors</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">currentEnvironment</span><span class="p">.</span><span class="nx">environment</span> <span class="o">===</span> <span class="s2">&quot;production&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;uncaughtException&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>TODO implement email sending</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">bunyan</span><span class="p">.</span><span class="nx">fatal</span><span class="p">({</span><span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;An uncaught exception was thrown&quot;</span><span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Configure </span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If we're testing, avoid logging everything restify tells us to avoid cluttering the screen</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">currentEnvironment</span><span class="p">.</span><span class="nx">environment</span> <span class="o">===</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">server</span> <span class="o">=</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">createServer</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;tldr API&quot;</span>
  <span class="p">});</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">server</span> <span class="o">=</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">createServer</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;tldr API&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>log: bunyan     // No restify logging for now</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Register restify middleware</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">restify</span><span class="p">.</span><span class="nx">acceptParser</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">acceptable</span><span class="p">));</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">restify</span><span class="p">.</span><span class="nx">queryParser</span><span class="p">({</span><span class="nx">mapParams</span><span class="o">:</span> <span class="kc">false</span><span class="p">}));</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">restify</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">({</span><span class="nx">mapParams</span><span class="o">:</span> <span class="kc">false</span><span class="p">}));</span>


<span class="cm">/**</span>
<span class="cm"> * Routes</span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>GET all tldrs</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/tldrs&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;0.1.0&#39;</span><span class="p">},</span> <span class="nx">requestHandlers</span><span class="p">.</span><span class="nx">getAllTldrs</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>GET a tldr by id</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/tldrs/:id&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;0.1.0&#39;</span><span class="p">},</span> <span class="nx">requestHandlers</span><span class="p">.</span><span class="nx">getTldrById</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>GET tldrs by hostname</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;domains/:hostname/tldrs&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;0.1.0&#39;</span><span class="p">},</span> <span class="nx">requestHandlers</span><span class="p">.</span><span class="nx">getAllTldrsByHostname</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>GET latest tldrs</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;tldrs/latest/:number&#39;</span><span class="p">,</span> <span class="nx">requestHandlers</span><span class="p">.</span><span class="nx">getLatestTldrs</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>POST a new tldr or update existing tldr</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span><span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/tldrs&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;0.1.0&#39;</span><span class="p">},</span> <span class="nx">requestHandlers</span><span class="p">.</span><span class="nx">postCreateOrUpdateTldr</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Start server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Code to execute only when running as main</span>
	<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8787</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(){</span>
		<span class="nx">bunyan</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Server %s launched at %s&#39;</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
	<span class="p">});</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">connectToDatabase</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>exports</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">server</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 